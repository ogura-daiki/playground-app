<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8" />

  <style>
    * {
      box-sizing: border-box;
    }

    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0px;
      padding: 0px;
    }
  </style>
</head>

<body>

  <script type="module">
    import { LitElement, html, css } from 'https://unpkg.com/lit-element/lit-element.js?module';

    const debounce = func=>{
      let timer;
      return {
        clear: () => {
          clearTimeout(timer);
        },
        push(time, props) {
          this.clear();
          timer = setTimeout(()=>func(false, props), time);
        },
        force(props) {
          this.clear();
          func(true, props);
        },
      };
    }

    class PlayGroundApp extends LitElement {
      static get properties(){
        return {
          store:{type:Object},
        };
      }
      constructor(){
        super();
        this.updater = debounce((force, {value, auto_refresh}) => {
          if(force || auto_refresh){
            this.renderRoot.querySelector("#ig").content = value;
          }
        });
        this.store = {
          config:{
            layout:1,
            refresh_wait:1000,
            auto_refresh:false,
          },
          data:{
            value:"",
          }
        };
      }
      static get styles(){
        return css`
          #container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-flow: row;
            background: #fff;
            gap: 4px;
          }

          #input {
            background: #000;
            color: #aaa;
            overflow: scroll;
            resize: none;
          }

          #ig {
            background: #eee;
          }

          .fill {
            width: 100%;
            height: 100%;
          }
        `;
      }
      render(){
        return html`
          <split-panel id="container" count=2 weight_sum=2 weights="[1,1]" min_weights="[0.1,0.1]">
            <div slot=0 class="fill" style="display:flex;flex-direction: column;">
              <textarea id="input" style="flex-basis:100px;flex-grow:1;" @input=${e=>{
                this.store.data.value = e.target.value;
                this.updater.push(this.store.config.refresh_wait, {
                  value:e.target.value,
                  auto_refresh:this.store.config.auto_refresh
                });
              }}>${this.store.data.value}</textarea>
              <div>
                <label>自動反映<input type="checkbox" .checked=${this.store.config.auto_refresh} @input=${e=>this.store.config.auto_refresh = e.target.checked}></label>
                <button id="run" @click=${e=>{
                  this.updater.force({value:this.store.data.value});
                }}>RUN</button>
              </div>
            </div>
            <div slot=1 class="fill">
              <i-g id="ig" class="fill" slot=1 .content=${this.store.data.value}></i-g>
            </div>
          </split-panel>
        `;
      }
    }
    customElements.define("playground-app", PlayGroundApp);
    document.body.append(new PlayGroundApp());

    class InputGround extends HTMLElement {
      constructor(){
        super();
        this.attachShadow({mode:"open"});
        this.shadowRoot.innerHTML = `
        <style>${this.constructor.style}</style>
        <iframe id="iframe">
        `;
      }
      set content(val){
        this.shadowRoot.querySelector("#iframe").srcdoc = val;
      }
      static get style(){
        return `
          :host{
            display:block;
          }
          html,body{
            width:100%;
            height:100%;
          }
          iframe{
            display:block;
            outline:none;
            border:none;
            width:100%;
            height:100%;
          }
        `;
      }
    }
    customElements.define("i-g", InputGround);
    

    class Split extends LitElement {
      static get properties() {
        return {
          vertical: { type: Boolean },
          count: { type: Number },
          weight_sum: { type: Number },
          weights: { type: Array },
          min_weights: { type: Array },
          knob_overflow: { type: Boolean },
          md: { state: true },
        };
      }
      updateCurrentWeight(val) {
        this.currentWeight = this.weights.map(v => v / this.weight_sum);
      }
      constructor() {
        super();
        this.vertical = false;
        this.count = 5;
        this.weight_sum = 1;
        this.weights = [0.1, 0.2, 0.2, 0.2, 0.3];
        this.min_weights = [0.05, 0.05, 0.05, 0.05, 0.05];
        this.currentWeight = [];
        this.knob_overflow = false;
      }
      connectedCallback() {
        super.connectedCallback();
        window.addEventListener("mousemove", e => {
          if (this.md !== null) {
            let move = e.movementX / this.offsetWidth;
            if (this.vertical) {
              move = e.movementY / this.offsetHeight;
            }
            if (move < 0) {
              if (this.currentWeight[this.md] + move < this.min_weights[this.md]) {
                move = (this.min_weights[this.md] - this.currentWeight[this.md]) / this.weight_sum;
              }
              this.currentWeight[this.md] += move;
              this.currentWeight[this.md + 1] -= move;
            }
            else {
              if (this.currentWeight[this.md + 1] - move < this.min_weights[this.md + 1]) {
                move = (this.currentWeight[this.md + 1] - this.min_weights[this.md + 1]) / this.weight_sum;
              }
              this.currentWeight[this.md] += move;
              this.currentWeight[this.md + 1] -= move;
            }
            this.requestUpdate();
          }
        });
        window.addEventListener("mouseup", e => {
          this.md = null;
        });
      }
      createKnob(i) {
        const knob = html`
          <div class="knob ${this.vertical ? "v" : "h"}"
          @mousedown=${e => {
            this.md = i;
          }}></div>
        `;
        if (this.knob_overflow) {
          return html`
            <div style="
              overflow:visible;
              ${this.vertical ? "height" : "width"}:0px;
              position:relative;
              user-select:none;
            ">
              <div class="knob ${this.vertical ? "v" : "h"}" style="
                ${this.vertical ? "top" : "left"}:-4px;
                position:absolute;
              "
              @mousedown=${e => {
              this.md = i;
              console.log(i);
            }}></div>
            </div>
          `;
        }
        else {
          return knob;
        }
      }
      render() {
        if (this.currentWeight.length !== this.count) {
          this.updateCurrentWeight(this.count);
        }
        return html`
        <style>
          :host{
            cursor:${this.vertical ? "row-resize" : "col-resize"};
          }
        </style>
        <div style="width:100%;height:100%;display:flex;align-items:stretch;flex-direction:${this.vertical ? "column" : "row"};">
        ${[...Array(this.count)].map((v, i) => html`
          <slot
            name="${i}"
            style="
              ${this.md !== null ? "user-select:none;pointer-events:none;" : ""}
              ${this.vertical ? "height" : "width"}:${this.currentWeight[i] * 100}%;
              display:block;
              overflow:hidden;
            "
          >${i}</slot>
        `).reduce((c, v, i) => {
          c.push(v);
          if (i + 1 < this.count) {
            c.push(this.createKnob(i));
          }
          return c;
        }, [])}
        </div>
    `;
      }
      static get styles() {
        return css`
          :host{
            display:block;
          }
          .knob.h{
            background:rgba(99,99,99,.2);
            width:8px;
            height:max(100%,8px);
            border:solid rgba(50,50,50,.2) 1px;
            user-select:none;
            box-sizing:border-box;
            cursor:col-resize;
          }
          .knob.v{
            background:rgba(99,99,99,.2);
            height:8px;
            width:max(100%,8px);
            border:solid rgba(50,50,50,.2) 1px;
            user-select:none;
            box-sizing:border-box;
            cursor:row-resize;
          }
        `;
      }
    }

    customElements.define("split-panel", Split);
  </script>


</body>

</html>